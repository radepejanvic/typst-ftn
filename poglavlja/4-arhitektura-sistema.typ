#import "../funkcije.typ": todo
= Архитектура система
<архитектура_система>

Ово поглавље приказује преглед концептуалнoг модела решења (поглавље #link(<концептуални_модел>)[3.1]) као и преглед свих фукционалности решења (поглавље #link(<концептуални_модел>)[3.1]).  Решење је реализовано као CLI алат који се компајлира у бинарну датотеку и на тај начин пружа сет команди за интеракцију са самим алатом. 

== Концептуални модел решења
<концептуални_модел>

Архитектура система заснива се на модуларном дизајну који омогућава једноставно проширивање функционалности и јасно раздвајање одговорности између компоненти. Систем је организован у три логичка слоја: кориснички интерфејс (CLI), језгро система (_Core_) и механизам за управљање виртуелним машинама (_Backend_). Архитектура система приказана је на слици #link(<fig:wormhole>)[7] на високом нивоу апстракције. 

#figure(image("../slike/wormhole.svg", width: 35%),
  caption: [
    Архитектура решења на највишем нивоу.
  ]
)<fig:wormhole>

CLI слој представља улазну тачку система. Задужен је за обраду корисничких команди и параметара конфигурације, као и за комуникацију са _Core_ слојем који извршава одговарајуће операције.

_Core_ слој чини централни део система и дефинише скуп функционалности (енгл. _interface_) које сваки _Backend_ мора да имплементира. Он управља животним циклусом виртуелних машина, оркестрира операције над њима и обезбеђује апстракцију између CLI и _Backend_ слојева.

_Backend_ слој садржи конкретну имплементацију механизма за креирање и управљање виртуелним машинама. Тренутно је реализован преко _VagrantBackend_-а, али архитектура омогућава додавање других провајдера без измене осталих делова система.

Захваљујући оваквој организацији, систем је лако проширив и прилагодљив различитим окружењима. Свaки слој је независан, што омогућава развој и тестирање компоненти без међусобне зависности и поједностављује интеграцију нових функционалности.

== Функционалности решења
У овом раду анализира се ток функционалности заснован на постојећој имплементацији _Backend_-а, која је реализована као омотач око _Vagrant_-а. Сви даљи описи односе се на овај конкретан _VagrantBackend_.

Свака функционалност одговара одређеној команди која се извршава из командне линије и активира специфичан ток извршавања унутар система. У табели #link(<tbl:functionalnosti>
)[1] приказане су све подржане команде и њихови описи.

#figure(
  table(
    columns: 3,
    align: (col, row) => (left,left,left).at(col),
    inset: 6pt,
    [Функционалност], [Команда], [Опис],
    [Иницијализација \ окружења], [`wormhole setup --config <path>`], [Учитава YAML конфигурациони фајл и припрема дефиницију виртуелних машина.],
    [Креирање виртуелних машина], [`wormhole create [node...]`], [Креира једну или више виртуелних машина.],
    [Заустављање виртуелних машина], [`wormhole stop [node...]`], [Суспендује једну или више виртуелних машина.],
    [Наставак рада \ виртуелних машина], [`wormhole resume [node...]`], [Наставља рад једне или више виртуелних машина након суспендовања.],
    [Поновно креирање и \ покретање виртуелних машина], [`wormhole reload [node...]`], [Поново креира виртуелне машине на основу конфигурације.],
    [Гашење виртуелних \ машина], [`wormhole shutdown [node...]`], [Гаси виртуелне машине на контролисан начин, чувајући податке.],
    [Брисање виртуелних \ машина], [`wormhole destroy [node...]`], [Брише једну или више виртуелних машине и све њихове податке.],
    [Покретање сервиса], [`wormhole start-nodes [node...]`], [Покреће извршавање сервиса на виртуелним машинама.],
    [Заустављање сервиса], [`wormhole stop-nodes [node...]`], [Зауставља извршавање сервиса на виртуелним машинама.],
    [Покретање _control plane_-а], [`wormhole start-control`], [Иницијализује _control plane_ сервисе на _host_ машини.], 
    [Заустављање \ _control plane_-а], [`wormhole stop-control`], [Зауставља _control plane_ сервисе на _host_ машини.]
  ),
  caption: [Преглед функционалности Wormhole алата]
)<tbl:functionalnosti>

=== Иницијализација окружења
Процес иницијализације окружења представља полазну тачку рада _Wormhole_ алата. Сврха ове функционалности је да на основу конфигурационe датотеке, чија је структура приказана у табели #link(<tbl:yaml>)[2],  припреми све потребне параметре за креирање виртуелних машина и мрежно повезивање. Резултат овог корака је окружење спремно за покретање.

Корисник прво уноси команду `wormhole setup --config config.yml` у командну линију. CLI слој учитава конфигурациону датотеку на прослеђеној путањи и позива функцију за иницијализацију окружења из _Core_ слоја. _Core_ мапира позив на одговарајући _Backend_ (_VagrantBackend_ у овом случају). _VagrantBackend_ генерише _Vagrantfile_ на основу прослеђене конфигурације. На слици #link(<fig:seq_diagram_1>)[8] приказан је дијаграм секвенце који описује претходно објашњену функционалност.  

#figure(image("../slike/seq-diagram-1.svg", width: auto),
  caption: [
    Дијаграм секвенце функционалности иницијализације окружења.
  ]
)<fig:seq_diagram_1>

#figure(
    table(
        columns: 2,
        align: (col, row) => (left,left).at(col),
        inset: 6pt,
        [Параметар], [Опис],
        [vmCount], [Број виртуелних машина које ће бити креиране.],
        [osDistro], [Идентификатор слике оперативног система.],
        [osVersion], [Верзија слике оперативног система.],
        [cpus], [Број процесорских језгара додељених свакој виртуелној машини.],
        [memory], [Количина RAM меморије (у MB) додељена свакој виртуелној машини.],
        [gui], [Булова вредност, `true` ако виртуелна машина треба да буде покренута са GUI прозором, `false` за _headless_ режим.],
        [ipBase], [Почетни део IP адресе који се користи за генерисање адреса виртуелних машина.],
        [guestPort], [Порт унутар виртуелне машине за сервис који треба да буде откривен.],
        [hostPortBase], [Полазни _host_ порт који се користи за мапирање _guestPort_-а виртуелних машина.],
        [nameBase], [Префикс _hostname_-а.],
        [backendType], [Тип _Backend_-а који ће управљати виртуелним машинама.]
    ),
    caption: [Структура конфигурационe YAML датотеке.]
)<tbl:yaml>

=== Креирање виртуелних машина
Процес креирања виртуелних машина представља следећи корак након успешне иницијализације окружења. Задатак ове функционалности је да на основу параметара дефинисаних у _Vagrantfile_-у (генерисаном током иницијализације), аутоматски изгради и покрене једну или више виртуелних машина које чине радно окружење. 

Корисник покреће команду `wormhole create [node ...]` са опционим аргументом назива виртуелних машина уколико жели да креира само одређене виртуелне машине из конфигурације. CLI слој прихвата захтев и прослеђује га _Core_ модулу, који затим позива одговарајући _VagrantBackend_, задужен за покретање виртуелних машина путем _Vagrant_ API-ја. На слици #link(<fig:seq_diagram_2>)[9] приказан је дијаграм секвенце који описује претходно објашњену функционалност.

#figure(image("../slike/seq-diagram-2.svg", width: auto),
  caption: [
    Дијаграм секвенце функционалности креирања виртуелних машина.
  ]
)<fig:seq_diagram_2>

Успешним извршавањем ове функционалности, окружење добија све дефинисане виртуелне машине са инсталираним сервисима и зависностима, спремним за даље покретање.

=== Заустављање виртуелних машина
Функционалност заустављања виртуелних машина омогућава контролисано суспендовање радног окружења ради ослобађања системских ресурса или припреме за касније настављање рада. Циљ овог корака је да се покренуте виртуелне машине у оквиру дефинисаног окружења доведу у стање мировања без губитка података или промене конфигурације.

Корисник покреће команду `wormhole stop [node ...]` са опционим аргументом који одређује једну или више виртуелних машина за заустављање. Уколико аргумент није наведен, _Wormhole_ CLI аутоматски зауставља све машине дефинисане у конфигурацији. CLI слој прослеђује захтев _Core_ модулу, који позива методу из _VagrantBackend_-а задужен за суспензију виртуелних машина путем _Vagrant_ API-ја. На слици #link(<fig:seq_diagram_3>)[10] приказан је дијаграм секвенце који описује претходно објашњену функционалност.

#figure(image("../slike/seq-diagram-3.svg", width: auto),
  caption: [
    Дијаграм секвенце функционалности заустављања виртуелних машина.
  ]
)<fig:seq_diagram_3>

Извршавањем ове функционалности виртуелне машине прелазе у стање _suspended_, задржавајући тренутно стање меморије и система, што омогућава брзо настављање рада у наредном кораку (_resume_). 

=== Наставак рада виртуелних машина
Функционалност наставка рада виртуелних машина омогућава поновно активирање претходно суспендованих виртуелних окружења. Сврха овог корака је да се систем врати у стање у којем је био пре заустављања, како би се наставио рад без потребе за поновним креирањем или иницијализацијом окружења.

Корисник покреће команду `wormhole resume [node ...]` са опционим аргументом који одређује једну или више виртуелних машина које треба поново покренути. Уколико аргумент није наведен, Wormhole CLI аутоматски наставља рад свих виртуелних машина дефинисаних у конфигурацији. CLI слој прослеђује захтев _Core_ модулу, који затим позива методу из _VagrantBackend_-а задужену за наставак рада виртуелних машина путем _Vagrant_ API-ја. На слици #link(<fig:seq_diagram_4>)[11] приказан је дијаграм секвенце који описује претходно објашњену функционалност.

#figure(image("../slike/seq-diagram-4.svg", width: auto),
  caption: [
    Дијаграм секвенце функционалности наставка рада виртуелних машина.
  ]
)<fig:seq_diagram_4>

Извршавањем ове функционалности виртуелне машине се враћају из стања _suspended_ у активно, при чему се задржава претходно стање система и подаци унутар сваке машине. На тај начин омогућен је континуитет развојног окружења без потребе за поновним покретањем сервиса.

=== Поновно креирање и покретање виртуелних машина
Функционалност поновног креирања и покретања виртуелних машина омогућава обнављање окружења на основу најновије конфигурације дефинисане у _Vagrantfile_-у. Сврха овог корака је да се обезбеди освежавање система након измена у конфигурационој датотеци или ажурирања софтверских компоненти, без потребе за ручним брисањем и поновним подизањем окружења.

Корисник покреће команду `wormhole reload [node ...]` са опционим аргументом који одређује једну или више виртуелних машина које треба поново креирати и покренути. Уколико аргумент није наведен, _Wormhole_ CLI извршава поступак над свим машинама дефинисаним у конфигурацији. CLI слој прослеђује захтев _Core_ модулу, који затим позива методу из _VagrantBackend_-а задужену за поновно креирање и покретање виртуелних машина путем _Vagrant_ API-ја. На слици #link(<fig:seq_diagram_5>)[12] приказан је дијаграм секвенце који описује претходно објашњену функционалност.

#figure(image("../slike/seq-diagram-5.svg", width: auto),
  caption: [
    Дијаграм секвенце функционалности поновног креирања и покретања виртуелних машина.
  ]
)<fig:seq_diagram_5>

Извршавањем ове функционалности све виртуелне машине се гасе и затим поново покрећу, при чему се ажурирају сви параметри дефинисани у конфигурационој датотеци. 

=== Гашење виртуелних машина
Функционалност гашења виртуелних машина омогућава контролисано искључивање радног окружења. За разлику од суспендовања (_stop_) где се стање меморије чува, гашењем се машине у потпуности искључују, што омогућава ослобађање свих системских ресурса и чини овај корак погодним када се окружење више не користи у текућој сесији.

Корисник покреће команду `wormhole shutdown [node ...]` са опционим аргументом који одређује једну или више виртуелних машина које треба искључити. Уколико аргумент није наведен, Wormhole CLI извршава поступак над свим машинама дефинисаним у конфигурацији. CLI слој прослеђује захтев _Core_ модулу, који затим позива методу из _VagrantBackend_-а задужену за гашење виртуелних машина путем _Vagrant_ API-ја. На слици #link(<fig:seq_diagram_6>)[13] приказан је дијаграм секвенце који описује претходно објашњену функционалност.

#figure(image("../slike/seq-diagram-6.svg", width: auto),
  caption: [
    Дијаграм секвенце функционалности гашења виртуелних машина.
  ]
)<fig:seq_diagram_6>

Извршавањем ове функционалности све виртуелне машине се уредно искључују, при чему се њихово стање не чува у меморији. Овај корак представља крај активне сесије рада у _Wormhole_ окружењу и претходи евентуалном уништавању окружења (_destroy_).

=== Брисање виртуелних машина
Функционалност брисања виртуелних машина представља завршни корак у управљању радним окружењем. Њена сврха је трајно уклањање свих виртуелних машина и њихових података, чиме се систем враћа у почетно стање и ослобађају се сви заузети ресурси. Овај корак се најчешће користи након завршетка развојног или тестног циклуса када више није потребно задржати претходно окружење.

Корисник покреће команду `wormhole destroy [node ...]` са опционим аргументом који одређује једну или више виртуелних машина које треба поново креирати и покренути. Уколико аргумент није наведен, _Wormhole_ CLI извршава поступак над свим машинама дефинисаним у конфигурацији. CLI слој прослеђује захтев Core модулу, који затим позива методу из _VagrantBackend_-а задужену за уништавање виртуелних машина и уклањање њихових придружених ресурса путем _Vagrant_ API-ја. На слици #link(<fig:seq_diagram_7>)[14] приказан је дијаграм секвенце који описује претходно објашњену функционалност.

#figure(image("../slike/seq-diagram-7.svg", width: auto),
caption: [
Дијаграм секвенце функционалности брисања виртуелних машина.
]
)<fig:seq_diagram_7>

Извршавањем ове функционалности све виртуелне машине и њихови повезани подаци се трајно бришу. Након овог корака, систем остаје без активних инстанци, што омогућава поновну иницијализацију окружења од самог почетка или потпуно искључивање развојне инфраструктуре.

=== Покретање сервиса на чворовима
Функционалност покретања чворова представља корак у којем се активирају сервиси унутар сваке виртуелне машине дефинисане у окружењу. Циљ овог процеса је да се након успешног креирања и покретања инфраструктуре омогући подизање софтверских компоненти које чине радне чворове система.

Корисник покреће команду `wormhole start-nodes [node ...]` са опционим аргументом којим може ограничити извршавање само на поједине чворове. CLI слој прихвата захтев и прослеђује га _Core_ модулу, који позива методу из _VagrantBackend_-а задужену за даљу оркестрацију. За разлику од претходних функционалности, _VagrantBackend_ у овом случају не управља директно животним циклусом виртуелних машина, већ користи механизам удаљеног приступа путем `vagrant ssh` команде ради извршавања скрипте за покретање сервиса унутар сваке машине. На слици #link(<fig:seq_diagram_8>)[15] приказан је дијаграм секвенце који описује претходно објашњену функционалност.

#figure(image("../slike/seq-diagram-8.svg", width: auto),
  caption: [
    Дијаграм секвенце функционалности покретања сервиса на чворовима.
  ]
)<fig:seq_diagram_8>

Извршавањем ове функционалности, сви дефинисани чворови у окружењу покрећу своје сервисе и успостављају комуникацију са _control plane_-ом, чиме окружење постаје потпуно оперативно и спремно за даљи развој и тестирање.

=== Заустављање сервиса на чворовима
Функционалност заустављања чворова омогућава контролисано заустављање свих сервиса покренутих унутар виртуелних машина. Сврха овог корака је да се радни чворови система уредно искључе, како би се спречили губитак података и неконзистентност током гашења или реконфигурације окружења.

Корисник покреће команду `wormhole stop-nodes [node ...]` са опционим аргументом којим може ограничити извршавање само на поједине чворове. CLI слој прихвата захтев и прослеђује га _Core_ модулу, који позива одговарајућу методу из _VagrantBackend_-а. Као и код покретања чворова, _VagrantBackend_ користи механизам удаљеног приступа путем `vagrant ssh` команде ради извршавања скрипте за гашење сервиса унутар сваке машине. На слици #link(<fig:seq_diagram_9>)[16] приказан је дијаграм секвенце који описује претходно објашњену функционалност.

#figure(image("../slike/seq-diagram-9.svg", width: auto),
  caption: [
    Дијаграм секвенце функционалности заустављања сервиса на чворовима.
  ]
)<fig:seq_diagram_9>

Извршавањем ове функционалности, сви активни чворови у окружењу уредно заустављају своје сервисе и прекидају комуникацију са _control plane_-ом, чиме се систем доводи у стабилно и безбедно стање мировања.

=== Покретање _control plane_-а
Функционалност покретања _control plane_-а представља корак у којем се иницијализује централни део система задужен за управљање и координацију свих чворова унутар окружења. Сврха овог процеса је успостављање сервиса који омогућавају надзор, комуникацију и оркестрацију између различитих компоненти _Constellations_ пројекта.

Корисник покреће команду `wormhole start-control`, чиме се иницира процес подизања _control plane_-а на _host_ машини. CLI слој прихвата захтев и прослеђује га _Core_ модулу, који у овом случају директно извршава скрипту за покретање сервиса без посредовања _VagrantBackend_-а. Ова скрипта, која се налази у оквиру `c12s/tools` репозиторијума, покреће све неопходне контејнере и сервисе у _Docker_ окружењу. На слици #link(<fig:seq_diagram_10>)[17] приказан је дијаграм секвенце који описује претходно објашњену функционалност.

#figure(image("../slike/seq-diagram-10.svg", width: 60%),
  caption: [
    Дијаграм секвенце функционалности покретања _control plane_-а.
  ]
)<fig:seq_diagram_10>

Извршавањем ове функционалности, _control plane_ постаје активан и спреман за комуникацију са чворовима, чиме се успоставља потпуно функционално окружење за управљање системом.

=== Заустављање _control plane_-а
Функционалност заустављања _control plane_-а омогућава контролисано искључивање централног дела система задуженог за управљање чворовима. Сврха овог процеса је уредно заустављање свих активних сервиса и ослобађање ресурса _host_ машине, без нарушавања интегритета података или конфигурације окружења.

Корисник покреће команду` wormhole stop-control`, којом се иницира поступак гашења _control plane_-а. CLI слој прихвата захтев и прослеђује га _Core_ модулу, који директно извршава скрипту за заустављање сервиса без посредовања _VagrantBackend_-а. Скрипта, која је део `c12s/tools` репозиторијума, зауставља све активне контејнере и сервисе покренуте у `Docker` окружењу. На слици #link(<fig:seq_diagram_11>)[18] приказан је дијаграм секвенце који описује претходно објашњену функционалност.

#figure(image("../slike/seq-diagram-11.svg", width: 60%),
  caption: [
    Дијаграм секвенце функционалности ѕаустављања _control plane_-а.
  ]
)<fig:seq_diagram_11>

Извршавањем ове функционалности, сви сервиси у оквиру _control plane_-а се уредно искључују, чиме се систем доводи у стабилно стање мировања и припрема за могуће поновно покретање или потпуно гашење окружења.